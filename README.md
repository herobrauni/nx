# NixOS Configuration with Dynamic Host Discovery

This repository contains NixOS configurations for multiple hosts with dynamic host discovery. It uses the flake.nix system to manage configurations and deploy-rs for deployment.

## Repository Structure

- `flake.nix`: The main entry point that defines the NixOS configurations and deployment settings
- `hosts/`: Contains host-specific configurations
- `modules/`: Contains shared modules that can be imported by hosts
- `roles/`: Contains role-specific configurations (e.g., web server, database server)
- `secrets/`: Contains encrypted secrets managed by sops-nix

## Common Configuration

All hosts automatically include a common configuration defined in `modules/common.nix`. This provides:

- Basic system settings (timezone, locale, etc.)
- SSH server configuration with secure defaults
- Common system packages
- Firewall configuration
- System maintenance settings
- Security hardening

## Adding a New Host

To add a new host:

1. Create a new directory under `hosts/` with the hostname
2. Create a `configuration.nix` file in that directory with host-specific settings
3. Create a `hardware-configuration.nix` file in that directory (generated by `nixos-generate-config`)

The new host will be automatically discovered by the flake.nix system and included in the NixOS configurations.

Example minimal host configuration:

```nix
{ config, lib, pkgs, ... }:

{
  imports = [
    ./hardware-configuration.nix
  ];

  # Host-specific settings
  networking.hostName = "my-new-host";
  
  # Host-specific network configuration
  networking = {
    interfaces.eth0.ipv4.addresses = [{
      address = "192.168.1.100";
      prefixLength = 24;
    }];
    defaultGateway = {
      address = "192.168.1.1";
      interface = "eth0";
    };
  };

  # Boot loader configuration
  boot.loader.grub.enable = true;
  boot.loader.grub.device = "/dev/sda";
  
  # System state version
  system.stateVersion = "24.11";
}
```

# Sops-Nix Secret Management

This repository uses [sops-nix](https://github.com/Mic92/sops-nix) for secret management. This README explains how to set up and use sops-nix with this configuration.

## Setup Instructions

### 1. Install Required Tools

First, install the required tools:

```bash
# Using nix-shell
nix-shell -p sops age ssh-to-age

# Or using nix-env
nix-env -iA nixpkgs.sops nixpkgs.age nixpkgs.ssh-to-age
```

### 2. Generate or Convert Keys

#### For Administrators

Generate an age key for yourself (as an administrator):

```bash
# Generate a new age key
mkdir -p ~/.config/sops/age
age-keygen -o ~/.config/sops/age/keys.txt

# Or convert an existing SSH key (if you have an ed25519 key)
mkdir -p ~/.config/sops/age
ssh-to-age < ~/.ssh/id_ed25519.pub > ~/.config/sops/age/keys.txt.pub
```

Get your public key:

```bash
# If you generated a new key
age-keygen -y ~/.config/sops/age/keys.txt

# Or if you converted an SSH key
cat ~/.config/sops/age/keys.txt.pub
```

#### For Hosts

For each host, convert its SSH host key to an age key:

```bash
# On the host or via SSH
ssh-to-age < /etc/ssh/ssh_host_ed25519_key.pub
```

### 3. Update the .sops.yaml File

Edit the `.sops.yaml` file and replace the placeholder keys with your actual keys:

```yaml
keys:
  # Replace with your admin key
  - &admin_key age1youradminkeyhere

  # Replace with your host keys
  - &terabit1 age1yourhostkeyhere
  # Add more hosts as needed
```

### 4. Encrypt the Secrets File

Encrypt the secrets file:

```bash
# Make sure your SOPS_AGE_KEY_FILE is set to your private key
export SOPS_AGE_KEY_FILE=~/.config/sops/age/keys.txt

# Encrypt the file in place
sops --encrypt --in-place secrets/secrets.yaml
```

### 5. Using Secrets in NixOS

To use a secret in your NixOS configuration, uncomment and adjust the secret definitions in `modules/sops.nix`:

```nix
sops.secrets.example-secret = {};
sops.secrets.database-password = {};
```

Then reference the secret in your service configuration:

```nix
services.someService = {
  enable = true;
  passwordFile = config.sops.secrets.database-password.path;
};
```

## Adding New Secrets

To add a new secret:

1. Decrypt the secrets file:
   ```bash
   sops secrets/secrets.yaml
   ```

2. Add your new secret and save the file (it will be automatically re-encrypted)

3. Update your NixOS configuration to use the new secret

## Rotating Keys

If you need to add or remove a key:

1. Update the `.sops.yaml` file with the new keys
2. Re-encrypt the secrets file with the new keys:
   ```bash
   sops updatekeys secrets/secrets.yaml
   ```

## More Information

For more detailed information, refer to the [sops-nix documentation](https://github.com/Mic92/sops-nix).